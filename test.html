<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookmarkHub Manager - æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
        }
        .test-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border-left: 4px solid #28a745;
        }
        .test-data {
            background: #2d3748;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            margin: 0.5rem 0.5rem 0.5rem 0;
            cursor: pointer;
            border: none;
            font-size: 0.9rem;
        }
        .btn:hover {
            background: #0056b3;
        }
        .result {
            background: #e7f3ff;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            border-left: 4px solid #007bff;
        }
        .error {
            background: #ffe7e7;
            border-left-color: #dc3545;
        }
        .success {
            background: #e7ffe7;
            border-left-color: #28a745;
        }
    </style>
</head>
<body>
    <h1>ğŸ“š BookmarkHub Manager - æµ‹è¯•é¡µé¢</h1>
    
    <div class="test-section">
        <h2>ğŸ§ª æ•°æ®è¯†åˆ«æµ‹è¯•</h2>
        <p>æµ‹è¯•ä¹¦ç­¾å’Œæ–‡ä»¶å¤¹çš„æ­£ç¡®è¯†åˆ«</p>
        
        <button class="btn" onclick="testDataRecognition()">è¿è¡Œè¯†åˆ«æµ‹è¯•</button>
        <button class="btn" onclick="loadSampleData()">åŠ è½½ç¤ºä¾‹æ•°æ®</button>
        <button class="btn" onclick="testUIRendering()">æµ‹è¯•UIæ¸²æŸ“</button>
        <button class="btn" onclick="clearTestData()">æ¸…é™¤æµ‹è¯•æ•°æ®</button>
        
        <div id="recognition-result" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š æµ‹è¯•æ•°æ®</h2>
        <p>åŒ…å«æ–‡ä»¶å¤¹å’Œä¹¦ç­¾çš„æ··åˆæ•°æ®ç»“æ„</p>
        
        <div class="test-data" id="test-data-display">
{
  "browser": "Test Browser",
  "version": "1.0.0",
  "createDate": 1704067200000,
  "bookmarks": [
    {
      "title": "å¼€å‘å·¥å…·",
      "children": [
        {
          "title": "GitHub",
          "url": "https://github.com",
          "dateLastUsed": 1704067200000
        },
        {
          "title": "Stack Overflow", 
          "url": "https://stackoverflow.com",
          "dateLastUsed": 1704067200000
        }
      ]
    },
    {
      "title": "ç›´æ¥ä¹¦ç­¾",
      "url": "https://example.com",
      "dateLastUsed": 1704067200000
    },
    {
      "title": "ç©ºæ–‡ä»¶å¤¹",
      "children": []
    }
  ]
}
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ”— åŠŸèƒ½æµ‹è¯•</h2>
        <p>æµ‹è¯•å„é¡¹åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
        
        <button class="btn" onclick="testSearch()">æµ‹è¯•æœç´¢åŠŸèƒ½</button>
        <button class="btn" onclick="testPathGeneration()">æµ‹è¯•è·¯å¾„ç”Ÿæˆ</button>
        <button class="btn" onclick="testStorageRestore()">æµ‹è¯•å­˜å‚¨æ¢å¤</button>
        
        <div id="function-result" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“± åº”ç”¨é“¾æ¥</h2>
        <a href="index.html" class="btn">ğŸš€ æ‰“å¼€ä¸»åº”ç”¨</a>
        <a href="demo.html" class="btn">ğŸ“– æŸ¥çœ‹æ¼”ç¤º</a>
    </div>

    <script src="js/storage.js"></script>
    <script src="js/github.js"></script>
    <script src="js/bookmarks.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/app.js"></script>
    
    <script>
        // æµ‹è¯•æ•°æ®
        const testData = {
            "browser": "Test Browser",
            "version": "1.0.0", 
            "createDate": 1704067200000,
            "bookmarks": [
                {
                    "title": "å¼€å‘å·¥å…·",
                    "children": [
                        {
                            "title": "GitHub",
                            "url": "https://github.com",
                            "dateLastUsed": 1704067200000
                        },
                        {
                            "title": "Stack Overflow",
                            "url": "https://stackoverflow.com", 
                            "dateLastUsed": 1704067200000
                        },
                        {
                            "title": "å­æ–‡ä»¶å¤¹",
                            "children": [
                                {
                                    "title": "åµŒå¥—ä¹¦ç­¾",
                                    "url": "https://nested.example.com"
                                }
                            ]
                        }
                    ]
                },
                {
                    "title": "ç›´æ¥ä¹¦ç­¾",
                    "url": "https://example.com",
                    "dateLastUsed": 1704067200000
                },
                {
                    "title": "ç©ºæ–‡ä»¶å¤¹",
                    "children": []
                },
                {
                    "title": "éšè—ä¹¦ç­¾",
                    "url": "https://hidden.example.com",
                    "hidden": true
                }
            ]
        };

        // ç­‰å¾…åº”ç”¨åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                if (!window.app) {
                    console.log('ç­‰å¾…åº”ç”¨åˆå§‹åŒ–...');
                    await new Promise(resolve => {
                        const checkApp = () => {
                            if (window.app && window.app.initialized) {
                                resolve();
                            } else {
                                setTimeout(checkApp, 100);
                            }
                        };
                        checkApp();
                    });
                }
                console.log('æµ‹è¯•é¡µé¢å‡†å¤‡å°±ç»ª');
            } catch (error) {
                console.error('æµ‹è¯•é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
            }
        });

        // åŠ è½½ç¤ºä¾‹æ•°æ®
        async function loadSampleData() {
            try {
                const parseResult = window.githubManager.parseBookmarkHubData(testData);
                if (parseResult.success) {
                    await window.storageManager.saveBookmarks(parseResult.bookmarks);
                    await window.bookmarkManager.loadBookmarks();
                    showResult('recognition-result', 'ç¤ºä¾‹æ•°æ®åŠ è½½æˆåŠŸï¼', 'success');
                } else {
                    showResult('recognition-result', 'æ•°æ®è§£æå¤±è´¥: ' + parseResult.error, 'error');
                }
            } catch (error) {
                showResult('recognition-result', 'åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•æ•°æ®è¯†åˆ«
        async function testDataRecognition() {
            try {
                await loadSampleData();
                
                const bookmarks = window.bookmarkManager.bookmarks;
                const results = [];
                
                // é€’å½’åˆ†æä¹¦ç­¾ç»“æ„
                function analyzeStructure(items, level = 0) {
                    items.forEach(item => {
                        const indent = '  '.repeat(level);
                        if (item.children) {
                            results.push(`${indent}ğŸ“ ${item.title} (æ–‡ä»¶å¤¹, ${item.children.length} é¡¹)`);
                            analyzeStructure(item.children, level + 1);
                        } else if (item.url) {
                            results.push(`${indent}ğŸ”— ${item.title} (ä¹¦ç­¾: ${item.url})`);
                        } else {
                            results.push(`${indent}â“ ${item.title} (æœªçŸ¥ç±»å‹)`);
                        }
                    });
                }
                
                analyzeStructure(bookmarks);
                
                const resultText = `æ•°æ®ç»“æ„åˆ†æç»“æœï¼š\n\n${results.join('\n')}\n\nç»Ÿè®¡ä¿¡æ¯ï¼š\n${JSON.stringify(window.bookmarkManager.getStatistics(), null, 2)}`;
                showResult('recognition-result', resultText, 'success');
                
            } catch (error) {
                showResult('recognition-result', 'è¯†åˆ«æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•æœç´¢åŠŸèƒ½
        async function testSearch() {
            try {
                await loadSampleData();
                
                const searchResults = await window.bookmarkManager.searchBookmarks('GitHub');
                const resultText = `æœç´¢ "GitHub" çš„ç»“æœï¼š\n\n${JSON.stringify(searchResults, null, 2)}`;
                showResult('function-result', resultText, 'success');
                
            } catch (error) {
                showResult('function-result', 'æœç´¢æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•è·¯å¾„ç”Ÿæˆ
        async function testPathGeneration() {
            try {
                await loadSampleData();
                
                const bookmarks = window.bookmarkManager.bookmarks;
                const paths = [];
                
                function collectPaths(items, currentPath = '') {
                    items.forEach(item => {
                        const itemPath = currentPath ? `${currentPath}/${item.title}` : item.title;
                        const uiPath = window.uiManager.getItemPath(item);
                        
                        paths.push({
                            title: item.title,
                            type: item.children ? 'æ–‡ä»¶å¤¹' : 'ä¹¦ç­¾',
                            expectedPath: itemPath,
                            uiPath: uiPath,
                            match: itemPath === uiPath
                        });
                        
                        if (item.children) {
                            collectPaths(item.children, itemPath);
                        }
                    });
                }
                
                collectPaths(bookmarks);
                
                const resultText = `è·¯å¾„ç”Ÿæˆæµ‹è¯•ç»“æœï¼š\n\n${paths.map(p => 
                    `${p.type}: ${p.title}\n  æœŸæœ›è·¯å¾„: ${p.expectedPath}\n  UIè·¯å¾„: ${p.uiPath}\n  åŒ¹é…: ${p.match ? 'âœ…' : 'âŒ'}`
                ).join('\n\n')}`;
                
                showResult('function-result', resultText, 'success');
                
            } catch (error) {
                showResult('function-result', 'è·¯å¾„æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•å­˜å‚¨æ¢å¤
        async function testStorageRestore() {
            try {
                await loadSampleData();
                
                // è·å–åŸå§‹æ•°æ®
                const originalBookmarks = JSON.stringify(window.bookmarkManager.bookmarks);
                
                // ä¿å­˜åˆ°å­˜å‚¨
                await window.storageManager.saveBookmarks(window.bookmarkManager.bookmarks);
                
                // æ¸…ç©ºå†…å­˜æ•°æ®
                window.bookmarkManager.bookmarks = [];
                
                // ä»å­˜å‚¨æ¢å¤
                await window.bookmarkManager.loadBookmarks();
                const restoredBookmarks = JSON.stringify(window.bookmarkManager.bookmarks);
                
                const match = originalBookmarks === restoredBookmarks;
                const resultText = `å­˜å‚¨æ¢å¤æµ‹è¯•ï¼š\n\næ•°æ®å®Œæ•´æ€§: ${match ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}\n\næ¢å¤çš„æ•°æ®ï¼š\n${JSON.stringify(window.bookmarkManager.bookmarks, null, 2)}`;
                
                showResult('function-result', resultText, match ? 'success' : 'error');
                
            } catch (error) {
                showResult('function-result', 'å­˜å‚¨æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•UIæ¸²æŸ“
        async function testUIRendering() {
            try {
                await loadSampleData();
                
                // æµ‹è¯•æ¸²æŸ“ç»“æœ
                window.uiManager.renderBookmarks();
                
                // æ£€æŸ¥æ¸²æŸ“çš„å…ƒç´ 
                const bookmarkItems = document.querySelectorAll('.bookmark-item');
                const folderHeaders = document.querySelectorAll('.folder-header');
                
                const results = [];
                results.push(`æ¸²æŸ“ç»Ÿè®¡:`);
                results.push(`- ä¹¦ç­¾é¡¹: ${bookmarkItems.length} ä¸ª`);
                results.push(`- æ–‡ä»¶å¤¹: ${folderHeaders.length} ä¸ª`);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å¤šä½™å­—ç¬¦
                let hasExtraChars = false;
                bookmarkItems.forEach((item, index) => {
                    const html = item.outerHTML;
                    if (html.includes('">') || html.includes("'>")) {
                        hasExtraChars = true;
                        results.push(`âŒ ä¹¦ç­¾é¡¹ ${index + 1} åŒ…å«å¤šä½™å­—ç¬¦`);
                    }
                });
                
                if (!hasExtraChars) {
                    results.push(`âœ… æ‰€æœ‰ä¹¦ç­¾é¡¹æ¸²æŸ“æ­£å¸¸ï¼Œæ— å¤šä½™å­—ç¬¦`);
                }
                
                // æµ‹è¯•å³é”®èœå•
                results.push(`\nå³é”®èœå•æµ‹è¯•:`);
                const contextMenu = document.getElementById('context-menu');
                if (contextMenu) {
                    results.push(`âœ… å³é”®èœå•å…ƒç´ å­˜åœ¨`);
                } else {
                    results.push(`âŒ å³é”®èœå•å…ƒç´ ç¼ºå¤±`);
                }
                
                // æµ‹è¯•äº‹ä»¶ç»‘å®š
                let eventsBound = true;
                bookmarkItems.forEach(item => {
                    if (!item.onclick && !item.addEventListener) {
                        eventsBound = false;
                    }
                });
                
                results.push(`äº‹ä»¶ç»‘å®š: ${eventsBound ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}`);
                
                showResult('recognition-result', results.join('\n'), hasExtraChars ? 'error' : 'success');
                
            } catch (error) {
                showResult('recognition-result', 'UIæ¸²æŸ“æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸…é™¤æµ‹è¯•æ•°æ®
        async function clearTestData() {
            try {
                await window.storageManager.clearAllData();
                window.bookmarkManager.bookmarks = [];
                window.bookmarkManager.filteredBookmarks = [];
                showResult('recognition-result', 'æµ‹è¯•æ•°æ®å·²æ¸…é™¤', 'success');
            } catch (error) {
                showResult('recognition-result', 'æ¸…é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, text, type = 'success') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.style.display = 'block';
            element.innerHTML = `<pre>${text}</pre>`;
        }
    </script>
</body>
</html>